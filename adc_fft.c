// Sample from the ADC continuously at a particular sample rate
// and then compute an FFT over the data
//
// much of this code is from pico-examples/adc/dma_capture/dma_capture.c
// the rest is written by Alex Wulff (www.AlexWulff.com)

#include <stdio.h>
#include <math.h>

#include "pico/stdlib.h"
#include "hardware/adc.h"
#include "hardware/dma.h"
#include "kiss_fftr.h"

// set this to determine sample rate
// 0     = 500,000 Hz
// 960   = 50,000 Hz
// 9600  = 5,000 Hz
#define CLOCK_DIV 4800
#define FSAMP 10000

// Channel 0 is GPIO26
#define CAPTURE_CHANNEL 0
#define LED_PIN 25

// BE CAREFUL: anything over about 9000 here will cause things
// to silently break. The code will compile and upload, but due
// to memory issues nothing will work properly
#define NSAMP 1024

// globals
dma_channel_config cfg;
uint dma_chan;
float freqs[NSAMP];

void setup();
void sample(uint16_t *capture_buf);

uint16_t cap_buf[NSAMP] = {1713, 1713, 1699, 1704, 1700, 1692, 1688, 1682, 1698, 1710, 1718, 1712, 1685, 1683, 1691, 1688, 1686, 1696, 1685, 1691, 1685, 1681, 1683, 1690, 1694, 1691, 1690, 1689, 1690, 1692, 1691, 1696, 1696, 1702, 1706, 1718, 1729, 1748, 1748, 1729, 1716, 1726, 1731, 1729, 1734, 1729, 1733, 1739, 1742, 1747, 1748, 1753, 1760, 1768, 1798, 1811, 1806, 1797, 1792, 1816, 1821, 1830, 1838, 1849, 1856, 1867, 1885, 1903, 1912, 1915, 1897, 1892, 1899, 1907, 1912, 1922, 1930, 1942, 1944, 1953, 1962, 1968, 1965, 1969, 1963, 1962, 1963, 1960, 1961, 1966, 1963, 1959, 1961, 1980, 1995, 2000, 2011, 2016, 2023, 2028, 2036, 2028, 2026, 2028, 2035, 2041, 2049, 2056, 2060, 2059, 2053, 2035, 2043, 2052, 2053, 2057, 2062, 2075, 2083, 2082, 2054, 2042, 2054, 2053, 2043, 2042, 2048, 2048, 2044, 2043, 2043, 2042, 2037, 2034, 2031, 2025, 2025, 2024, 2020, 2016, 2013, 2014, 2014, 2018, 2011, 1960, 2001, 1995, 1992, 1981, 1985, 1985, 1978, 1973, 1949, 1944, 1944, 1945, 1939, 1928, 1916, 1918, 1914, 1896, 1883, 1876, 1858, 1841, 1830, 1833, 1846, 1844, 1840, 1834, 1827, 1812, 1805, 1797, 1797, 1794, 1793, 1785, 1776, 1767, 1775, 1776, 1776, 1778, 1780, 1778, 1779, 1785, 1780, 1748, 1752, 1748, 1739, 1730, 1728, 1717, 1711, 1700, 1707, 1705, 1702, 1708, 1689, 1685, 1681, 1688, 1688, 1691, 1689, 1688, 1689, 1692, 1689, 1685, 1687, 1693, 1692, 1688, 1692, 1698, 1717, 1728, 1698, 1692, 1686, 1686, 1693, 1691, 1695, 1698, 1702, 1707, 1713, 1711, 1717, 1721, 1724, 1722, 1730, 1730, 1733, 1732, 1737, 1738, 1742, 1744, 1722, 1753, 1757, 1768, 1787, 1810, 1818, 1811, 1800, 1809, 1822, 1813, 1827, 1835, 1844, 1859, 1877, 1900, 1908, 1915, 1906, 1891, 1899, 1902, 1910, 1919, 1931, 1941, 1948, 1953, 1956, 1959, 1963, 1968, 1965, 1962, 1960, 1960, 1960, 1960, 1957, 1957, 1953, 1968, 1990, 1998, 2008, 2014, 2021, 2017, 2024, 2031, 2035, 2031, 2037, 2056, 2072, 2078, 2077, 2054, 2049, 2053, 2050, 2053, 2054, 2051, 2049, 2052, 2049, 2051, 2051, 2052, 2058, 2057, 2052, 2042, 2048, 2048, 2043, 2048, 2042, 2050, 2056, 2061, 2053, 2043, 2027, 2019, 2021, 2015, 2016, 2013, 2011, 2006, 2004, 2001, 1989, 1992, 1992, 1994, 1988, 1977, 1980, 1977, 1970, 1949, 1938, 1947, 1946, 1923, 1926, 1921, 1915, 1898, 1889, 1876, 1867, 1846, 1841, 1829, 1836, 1848, 1843, 1833, 1831, 1812, 1805, 1801, 1801, 1796, 1795, 1787, 1779, 1768, 1762, 1775, 1778, 1780, 1779, 1779, 1781, 1780, 1784, 1753, 1746, 1748, 1742, 1728, 1721, 1713, 1713, 1708, 1710, 1707, 1704, 1700, 1692, 1690, 1684, 1678, 1682, 1694, 1702, 1711, 1717, 1708, 1692, 1685, 1689, 1689, 1692, 1688, 1682, 1684, 1686, 1696, 1692, 1688, 1691, 1688, 1691, 1689, 1693, 1696, 1701, 1705, 1709, 1714, 1722, 1729, 1740, 1744, 1740, 1725, 1723, 1732, 1732, 1738, 1739, 1746, 1744, 1752, 1750, 1758, 1766, 1787, 1800, 1809, 1810, 1803, 1815, 1811, 1818, 1827, 1841, 1858, 1871, 1891, 1906, 1914, 1914, 1894, 1889, 1894, 1904, 1913, 1925, 1936, 1942, 1950, 1949, 1950, 1957, 1966, 1971, 1966, 1961, 1959, 1961, 1960, 1958, 1960, 1956, 1962, 1985, 2001, 2007, 2014, 2017, 2019, 2026, 2030, 2033, 2030, 2030, 2036, 2038, 2042, 2050, 2058, 2064, 2062, 2056, 2050, 2052, 2051, 2051, 2052, 2051, 2052, 2060, 2065, 2072, 2078, 2080, 2049, 2040, 2050, 2050, 2044, 2041, 2049, 2053, 2037, 2034, 2032, 2033, 2025, 2016, 2026, 2016, 2014, 2011, 2012, 2008, 2004, 2001, 2004, 1995, 1993, 1995, 1994, 1981, 1989, 1975, 1958, 1945, 1936, 1947, 1941, 1932, 1921, 1917, 1911, 1892, 1884, 1882, 1857, 1843, 1834, 1841, 1845, 1844, 1835, 1832, 1824, 1822, 1808, 1801, 1803, 1797, 1789, 1784, 1777, 1769, 1768, 1773, 1776, 1776, 1779, 1780, 1780, 1784, 1781, 1750, 1745, 1729, 1736, 1725, 1720, 1718, 1714, 1706, 1718, 1732, 1734, 1704, 1693, 1681, 1675, 1681, 1686, 1688, 1685, 1684, 1683, 1685, 1687, 1692, 1690, 1690, 1689, 1686, 1681, 1686, 1692, 1694, 1689, 1691, 1692, 1698, 1697, 1693, 1723, 1700, 1702, 1706, 1715, 1714, 1716, 1721, 1715, 1722, 1724, 1728, 1731, 1729, 1734, 1734, 1736, 1757, 1745, 1746, 1757, 1756, 1780, 1798, 1802, 1818, 1817, 1824, 1822, 1824, 1829, 1834, 1843, 1851, 1878, 1894, 1894, 1912, 1902, 1898, 1889, 1901, 1913, 1918, 1920, 1936, 1945, 1955, 1953, 1960, 1964, 1969, 1971, 1968, 1966, 1963, 1968, 1964, 1964, 1957, 1953, 1969, 1987, 1997, 2004, 2015, 2024, 2030, 2034, 2033, 2027, 2028, 2035, 2035, 2041, 2050, 2057, 2064, 2069, 2077, 2080, 2072, 2064, 2060, 2050, 2043, 2051, 2050, 2050, 2044, 2049, 2058, 2051, 2040, 2041, 2043, 2042, 2043, 2044, 2043, 2040, 2042, 2033, 2026, 2025, 2024, 2033, 2038, 2049, 2041, 2017, 2006, 1988, 1996, 1996, 2002, 2001, 1996, 1986, 1983, 1977, 1977, 1966, 1950, 1941, 1933, 1938, 1936, 1929, 1920, 1911, 1897, 1890, 1884, 1867, 1851, 1832, 1835, 1841, 1846, 1834, 1834, 1827, 1810, 1804, 1805, 1803, 1799, 1797, 1792, 1777, 1770, 1763, 1771, 1778, 1777, 1779, 1779, 1782, 1779, 1773, 1776, 1746, 1744, 1732, 1736, 1725, 1713, 1709, 1702, 1714, 1713, 1704, 1700, 1694, 1686, 1682, 1686, 1688, 1692, 1684, 1690, 1686, 1688, 1688, 1689, 1691, 1693, 1702, 1712, 1715, 1713, 1694, 1689, 1694, 1689, 1689, 1688, 1692, 1692, 1693, 1694, 1704, 1705, 1716, 1714, 1716, 1715, 1723, 1723, 1732, 1721, 1729, 1733, 1732, 1739, 1738, 1728, 1747, 1750, 1754, 1759, 1765, 1792, 1804, 1811, 1810, 1814, 1806, 1820, 1831, 1841, 1843, 1851, 1860, 1876, 1909, 1915, 1913, 1907, 1894, 1907, 1907, 1917, 1926, 1938, 1945, 1950, 1947, 1950, 1955, 1963, 1974, 1971, 1967, 1958, 1960, 1961, 1957, 1957, 1957, 1956, 1976, 1989, 1998, 2008, 2014, 2022, 2030, 2035, 2049, 2060, 2069, 2061, 2036, 2067, 2036, 2050, 2058, 2056, 2049, 2049, 2053, 2052, 2058, 2056, 2048, 2050, 2048, 2051, 2055, 2058, 2064, 2066, 2066, 2067, 2061, 2022, 2038, 2040, 2043, 2035, 2036, 2028, 2025, 2024, 2020, 2018, 2018, 2012, 2011, 2009, 2005, 2002, 1997, 1997, 1992, 1984, 1989, 1985, 1984, 1982, 1980, 1973, 1950, 1938, 1938, 1937, 1931, 1920, 1918, 1906, 1899, 1884, 1878, 1860, 1841, 1833, 1840, 1843, 1844, 1838, 1833, 1825, 1811, 1804, 1804, 1801, 1799, 1794, 1786, 1773, 1768, 1774, 1776, 1779, 1779, 1778, 1779, 1780, 1784, 1769, 1749, 1745, 1743, 1737, 1729, 1722, 1716, 1710, 1715, 1709, 1707, 1704, 1709, 1714, 1710, 1682, 1698, 1689, 1683, 1690, 1685, 1685, 1686, 1688, 1690, 1689, 1692, 1692, 1685};
// uint16_t cap_buf[NSAMP] = {1894, 1878, 1873, 1896, 1900, 1909, 1913, 1921, 1901, 1902, 1898, 1903, 1923, 1942, 1953, 1964, 1973, 1980, 1989, 1996, 1998, 1994, 1995, 1998, 2003, 2009, 2017, 2021, 2026, 2030, 2025, 2019, 2022, 2028, 2028, 2025, 2025, 2024, 2025, 2025, 2029, 2035, 2041, 2051, 2048, 2054, 2048, 2020, 2016, 2023, 2020, 2022, 2018, 2012, 2010, 2006, 2004, 2000, 2003, 1998, 1995, 1994, 1988, 1984, 1982, 1988, 1978, 1980, 1951, 1972, 1962, 1966, 1970, 1962, 1929, 1922, 1933, 1924, 1912, 1903, 1896, 1891, 1885, 1872, 1865, 1851, 1827, 1813, 1808, 1817, 1824, 1824, 1817, 1802, 1791, 1782, 1777, 1780, 1779, 1773, 1766, 1755, 1750, 1743, 1747, 1749, 1753, 1753, 1756, 1752, 1757, 1759, 1726, 1723, 1724, 1716, 1699, 1698, 1688, 1689, 1685, 1688, 1686, 1680, 1684, 1693, 1689, 1683, 1667, 1661, 1665, 1667, 1664, 1665, 1662, 1666, 1667, 1669, 1670, 1673, 1666, 1660, 1667, 1675, 1677, 1671, 1667, 1671, 1675, 1674, 1678, 1681, 1696, 1706, 1729, 1728, 1740, 1718, 1748, 1732, 1718, 1770, 1769, 1710, 1765, 1721, 1756, 1721, 1744, 1753, 1768, 1764, 1786, 1868, 1891, 1839, 1844, 1874, 1913, 1878, 1857, 1901, 1920, 1901, 1968, 1961, 1996, 2008, 2029, 2034, 2038, 2030, 2032, 2025, 2036, 1922, 1880, 1874, 1888, 1906, 1918, 1918, 1929, 1937, 1932, 1924, 1924, 1924, 1929, 1929, 1923, 1916, 1936, 1956, 1965, 1972, 1977, 1986, 1995, 2001, 2005, 1998, 2004, 2006, 2008, 2011, 2018, 2025, 2031, 2028, 2021, 2025, 2026, 2031, 2037, 2042, 2051, 2048, 2040, 2020, 2028, 2032, 2032, 2026, 2017, 2026, 2022, 2026, 2027, 2021, 2018, 2017, 2018, 2011, 2004, 2001, 2006, 2003, 1996, 1995, 1923, 1997, 2004, 1995, 1979, 1976, 1974, 1970, 1973, 1969, 1966, 1963, 1957, 1951, 1932, 1921, 1928, 1921, 1917, 1916, 1909, 1892, 1881, 1873, 1866, 1860, 1835, 1816, 1813, 1827, 1834, 1838, 1830, 1810, 1803, 1795, 1788, 1788, 1786, 1780, 1775, 1768, 1760, 1756, 1768, 1769, 1772, 1770, 1769, 1776, 1774, 1778, 1746, 1740, 1735, 1728, 1724, 1717, 1718, 1714, 1709, 1718, 1706, 1699, 1693, 1688, 1685, 1678, 1672, 1686, 1689, 1687, 1684, 1676, 1689, 1688, 1691, 1688, 1689, 1691, 1684, 1682, 1688, 1694, 1701, 1715, 1712, 1711, 1711, 1725, 1727, 1741, 1736, 1716, 1764, 1735, 1750, 1765, 1756, 1758, 1748, 1747, 1751, 1751, 1751, 1738, 1749, 1774, 1772, 1738, 1737, 1797, 1832, 1916, 1885, 1886, 1853, 1861, 1886, 1885, 1879, 1865, 1963, 1918, 1981, 1955, 2028, 1976, 2005, 2020, 1985, 2008, 1993, 2015, 1962, 1902, 1880, 1872, 1891, 1909, 1923, 1929, 1934, 1942, 1935, 1924, 1916, 1920, 1923, 1924, 1922, 1923, 1938, 1954, 1965, 1973, 1980, 1992, 1996, 2002, 2009, 2002, 1994, 2004, 2010, 2018, 2044, 2064, 2068, 2034, 2028, 2017, 2028, 2028, 2027, 2026, 2027, 2025, 2026, 2027, 2033, 2038, 2037, 2029, 2024, 2027, 2026, 2028, 2025, 2025, 2024, 2022, 2026, 2032, 2036, 2032, 2012, 2000, 1989, 2000, 2008, 1986, 2008, 2018, 2028, 2002, 1984, 2002, 2021, 2023, 2018, 2038, 2029, 2060, 1992, 2001, 1992, 1982, 1997, 1971, 1973, 1982, 1971, 1971, 1958, 1944, 1929, 1939, 1939, 1939, 1923, 1945, 1961, 1903, 1902, 1825, 1794, 1771, 1757, 1749, 1744, 1738, 1731, 1732, 1733, 1736, 1737, 1741, 1746, 1745, 1744, 1746, 1715, 1708, 1702, 1697, 1689, 1683, 1675, 1673, 1667, 1669, 1666, 1664, 1660, 1659, 1652, 1648, 1641, 1650, 1650, 1651, 1647, 1648, 1653, 1660, 1672, 1680, 1685, 1666, 1651, 1645, 1654, 1666, 1662, 1685, 1705, 1683, 1661, 1695, 1702, 1662, 1683, 1709, 1691, 1692, 1670, 1708, 1692, 1762, 1701, 1739, 1715, 1716, 1729, 1734, 1688, 1731, 1739, 1746, 1728, 1748, 1814, 1848, 1870, 1812, 1830, 1803, 1837, 1813, 1833, 1904, 1903, 1931, 1937, 1958, 1996, 2021, 2054, 2077, 2024, 1983, 2009, 2002, 1978, 1969, 1913, 1881, 1868, 1901, 1913, 1924, 1933, 1942, 1936, 1931, 1930, 1928, 1926, 1926, 1924, 1931, 1957, 1969, 1978, 1982, 1993, 1998, 2007, 2016, 2037, 2037, 2043, 2018, 2025, 2027, 2035, 2042, 2053, 2052, 2048, 2034, 2043, 2049, 2044, 2038, 2038, 2040, 2040, 2044, 2042, 2052, 2048, 2080, 2093, 2110, 2074, 2062, 2059, 2041, 2036, 2038, 2035, 2028, 2035, 2059, 2036, 2013, 2022, 2017, 2027, 2021, 2002, 1993, 1996, 1997, 1996, 1995, 1993, 1980, 2001, 1988, 1996, 1998, 1989, 1962, 1944, 1947, 1946, 1953, 1951, 1939, 1944, 1960, 1933, 1931, 1905, 1874, 1930, 1960, 1952, 1899, 1931, 1893, 1881, 1874, 1841, 1795, 1770, 1758, 1749, 1741, 1733, 1728, 1730, 1733, 1736, 1738, 1738, 1742, 1742, 1714, 1710, 1701, 1696, 1691, 1678, 1673, 1667, 1661, 1664, 1664, 1661, 1664, 1671, 1672, 1665, 1647, 1641, 1635, 1639, 1642, 1640, 1649, 1643, 1645, 1652, 1709, 1742, 1688, 1675, 1644, 1682, 1702, 1672, 1653, 1652, 1685, 1669, 1658, 1675, 1690, 1706, 1704, 1704, 1704, 1682, 1688, 1700, 1700, 1721, 1719, 1700, 1713, 1712, 1705, 1726, 1734, 1716, 1711, 1739, 1736, 1793, 1795, 1794, 1810, 1812, 1837, 1869, 1820, 1845, 1902, 1988, 1925, 1903, 1981, 2012, 2012, 2019, 1967, 2025, 2022, 2004, 2000, 2080, 2098, 2062, 2042, 1986, 1940, 1904, 1896, 1907, 1920, 1928, 1938, 1939, 1932, 1923, 1917, 1921, 1932, 1954, 1966, 1977, 1981, 1989, 1996, 2003, 2013, 2011, 2004, 2011, 2018, 2026, 2032, 2034, 2035, 2032, 2032, 2076, 2105, 2094, 2093, 2088, 2059, 2056, 2043, 2056, 2067, 2060, 2076, 2069, 2056, 2052, 2040, 2033, 2032, 2037, 2034, 2034, 2029, 2024, 2028, 2025, 2028, 2026, 2072, 2101, 2067, 2029, 2009, 2004, 2000, 1987, 1993, 1976, 1983, 1986, 1977, 1970, 1970, 1969, 1957, 1946, 1964, 1963, 1970, 1937, 1925, 1930, 1915, 1978, 1981, 1966, 1939, 1948, 1958, 1973, 1838, 1955, 1902, 1940, 1948, 1934, 1912, 1921, 1830, 1771, 1751, 1741, 1730, 1721, 1717, 1723, 1723, 1727, 1725, 1729, 1731, 1734, 1708, 1700, 1691, 1683, 1681, 1675, 1670, 1665, 1656, 1658, 1659, 1656, 1652, 1650, 1645, 1701, 1717, 1734, 1662, 1672, 1686, 1698, 1682, 1723, 1682, 1683, 1691, 1692, 1706, 1712, 1683, 1686, 1676, 1661, 1645, 1660, 1648, 1644, 1645, 1659, 1660, 1725, 1689, 1703, 1702, 1686, 1713, 1717, 1730, 1715, 1705, 1712, 1709, 1702, 1674, 1717, 1722, 1716, 1696, 1715, 1750, 1774, 1868, 1804, 1804, 1853, 1797, 1795, 1873, 1902, 1873, 1931, 1939, 1956, 2004, 2048, 2065, 2048, 2026, 2050, 2064, 2067, 2142, 2164, 2114, 2098, 2138, 2097, 2038, 1967, 1898, 1887, 1881, 1895, 1904, 1899, 1900, 1902, 1892, 1898, 1904, 1936, 1946, 1955, 1957, 1965, 1947, 2049, 2084, 2089, 2061, 2054, 2049};

int main()
{
  kiss_fft_scalar fft_in[NSAMP]; // kiss_fft_scalar is a float
  kiss_fft_cpx fft_out[NSAMP];
  kiss_fftr_cfg cfg = kiss_fftr_alloc(NSAMP, false, 0, 0);

  // setup ports and outputs
  setup();

  while (1)
  {
    // get NSAMP samples at FSAMP
    sample(cap_buf);
    // fill fourier transform input while subtracting DC component
    uint64_t sum = 0;
    for (int i = 0; i < NSAMP; i++)
    {
      sum += cap_buf[i];
    }
    float avg = (float)sum / NSAMP;
    for (int i = 0; i < NSAMP; i++)
    {
      fft_in[i] = (float)cap_buf[i] - avg;
    }

    // compute fast fourier transform
    kiss_fftr(cfg, fft_in, fft_out);

    // compute power and calculate max freq component
    float max_power = 0;
    int max_idx = 0;
    // any frequency bin over NSAMP/2 is aliased (nyquist sampling theorum)
    for (int i = 0; i < NSAMP / 2; i++)
    {
      float power = fft_out[i].r * fft_out[i].r + fft_out[i].i * fft_out[i].i;
      printf("id: %04d: power %0.1f\n", i, power);
      if (power > max_power)
      {
        max_power = power;
        max_idx = i;
      }
      sleep_ms(10);
    }

    float max_freq = freqs[max_idx];
    // printf("Greatest Frequency Component: %0.1f Hz, index: %d\n", max_freq, max_idx);

    sleep_ms(1000000);
  }

  // should never get here
  kiss_fft_free(cfg);
}

void sample(uint16_t *capture_buf)
{
  adc_fifo_drain();
  adc_run(false);

  dma_channel_configure(dma_chan, &cfg,
                        capture_buf,   // dst
                        &adc_hw->fifo, // src
                        NSAMP,         // transfer count
                        true           // start immediately
  );

  gpio_put(LED_PIN, 1);
  adc_run(true);
  dma_channel_wait_for_finish_blocking(dma_chan);
  gpio_put(LED_PIN, 0);
}

void setup()
{
  stdio_init_all();

  gpio_init(LED_PIN);
  gpio_set_dir(LED_PIN, GPIO_OUT);

  adc_gpio_init(26 + CAPTURE_CHANNEL);

  adc_init();
  adc_select_input(CAPTURE_CHANNEL);
  adc_fifo_setup(
      true,  // Write each completed conversion to the sample FIFO
      true,  // Enable DMA data request (DREQ)
      1,     // DREQ (and IRQ) asserted when at least 1 sample present
      false, // We won't see the ERR bit because of 8 bit reads; disable.
      false  // Shift each sample to 8 bits when pushing to FIFO
  );

  // set sample rate
  adc_set_clkdiv(CLOCK_DIV);

  sleep_ms(1000);
  // Set up the DMA to start transferring data as soon as it appears in FIFO
  uint dma_chan = dma_claim_unused_channel(true);
  cfg = dma_channel_get_default_config(dma_chan);

  // Reading from constant address, writing to incrementing byte addresses
  channel_config_set_transfer_data_size(&cfg, DMA_SIZE_16);
  channel_config_set_read_increment(&cfg, false);
  channel_config_set_write_increment(&cfg, true);

  // Pace transfers based on availability of ADC samples
  channel_config_set_dreq(&cfg, DREQ_ADC);

  // calculate frequencies of each bin
  float f_max = FSAMP;
  float f_res = f_max / NSAMP;
  for (int i = 0; i < NSAMP; i++)
  {
    freqs[i] = f_res * i;
  }
}
